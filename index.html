<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diablo II Items Viewer</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    const devEnv = false; // set true for dev mode
/* Tiny $ helper fallback if jQuery CDN is unavailable.
   Supports only methods used by this page. */
(function(){
  if (window.jQuery) return;

  function wrap(nodes){
    nodes = Array.isArray(nodes) ? nodes : [nodes];
    const api = {
      _nodes: nodes,
      on(evt, handler){ nodes.forEach(n=>n && n.addEventListener(evt, handler)); return api; },
      off(evt, handler){ nodes.forEach(n=>n && n.removeEventListener(evt, handler)); return api; },
      val(v){
        if (v === undefined) return nodes[0] ? nodes[0].value : "";
        nodes.forEach(n=>{ if(n) n.value = v; });
        return api;
      },
      text(v){
        if (v === undefined) return nodes[0] ? nodes[0].textContent : "";
        nodes.forEach(n=>{ if(n) n.textContent = v; });
        return api;
      },
      html(v){
        if (v === undefined) return nodes[0] ? nodes[0].innerHTML : "";
        nodes.forEach(n=>{ if(n) n.innerHTML = v; });
        return api;
      },
      empty(){ nodes.forEach(n=>{ if(n) n.innerHTML = ""; }); return api; },
      append(v){
        nodes.forEach(n=>{
          if(!n) return;
          if (typeof v === "string") n.insertAdjacentHTML("beforeend", v);
          else if (v && v._nodes) v._nodes.forEach(ch=>ch && n.appendChild(ch));
          else if (v instanceof Node) n.appendChild(v);
        });
        return api;
      },
      addClass(c){ nodes.forEach(n=>n && n.classList.add(c)); return api; },
      removeClass(c){ nodes.forEach(n=>n && n.classList.remove(c)); return api; },
      toggleClass(c, force){ nodes.forEach(n=>n && n.classList.toggle(c, force)); return api; },
      find(sel){
        const found = [];
        nodes.forEach(n=> n && found.push(...n.querySelectorAll(sel)));
        return wrap(found);
      },
      data(key, value){
        if (!nodes[0]) return value === undefined ? undefined : api;
        if (value === undefined) return nodes[0].dataset[key];
        nodes.forEach(n=>{ if(n) n.dataset[key] = value; });
        return api;
      },
      css(prop, value){
        nodes.forEach(n=>{ if(!n) return; n.style[prop] = value; });
        return api;
      },
      trigger(evtName){
        nodes.forEach(n=>{
          if(!n) return;
          n.dispatchEvent(new Event(evtName, {bubbles:true}));
        });
        return api;
      }
    };
    return api;
  }

  window.$ = function(sel){
    if (typeof sel === "function"){
      if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", sel);
      else sel();
      return;
    }
    if (sel instanceof Node) return wrap(sel);
    const nodes = Array.from(document.querySelectorAll(sel));
    return wrap(nodes);
  };

  // Minimal $.getJSON replacement (same-origin only)
  $.getJSON = function(url){
    const obj = {
      done(fn){ obj._done = fn; return obj; },
      fail(fn){ obj._fail = fn; return obj; },
      _done:null, _fail:null
    };
    fetch(url).then(r=>{
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }).then(data=>{
      obj._done && obj._done(data);
    }).catch(err=>{
      obj._fail && obj._fail(err);
    });
    return obj;
  };
})();
</script>


  <style>

@font-face {
  font-family: 'ExocetBlizzard';
  src: url('ExocetBlizzardMixedCaps-Medium-CeveHi9Z.otf') format('opentype');
  font-weight: normal;
  font-style: normal;
}

    :root{
      --bg:#0b0b0c;
      --gold2:#6b4b16;
      --text:#d9d3c7;
      --muted:#9a948a;

      --c-white:#f3f3f3;
      --c-blue:#6fb6ff;
      --c-gold:#d7b45a;
      --c-green:#6cff6c;
      --c-gray:#bcb6ad;
      --c-red:#ff6b6b;
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 30% 10%, #1a1a1e 0%, var(--bg) 55%, #060607 100%);
      color:var(--text);
      font-family: 'ExocetBlizzard', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: 0.2px;
    }

    .wrap{
      max-width: 1200px;
      margin: 24px auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 18px;
    }

    .controls{
      grid-column: 1 / -1;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      flex-wrap: wrap;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
      padding-right: 6px;
    }
    .tab{
      cursor:pointer;
      user-select:none;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.85);
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(202,161,74,0.30), rgba(107,75,22,0.25));
      border-color: rgba(202,161,74,0.55);
      color: var(--c-white);
    }

    .controls input[type="text"], .controls select{
      background: rgba(0,0,0,0.4);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
      width: 100%;
      min-width: 220px;
      flex: 1 1 260px;
    }

    .fileHidden{position:absolute;left:-99999px;top:-99999px;width:1px;height:1px;opacity:0;pointer-events:none;}

    .dev-only{display:none;}

    .controls .btn{
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      background: linear-gradient(180deg, rgba(202,161,74,0.30), rgba(107,75,22,0.25));
      border: 1px solid rgba(202,161,74,0.45);
      color: var(--c-white);
      padding: 10px 12px;
      border-radius: 8px;
      flex: 0 0 auto;
      font-weight: 800;
    }
    .controls .btn:hover{ filter: brightness(1.08); }

    .hint{
      flex: 1 1 100%;
      color: rgba(255,255,255,0.70);
      font-size: 17px;
      margin-top: 2px;
    }

    .listPanel{
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.35));
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
      overflow:hidden;
    }
    .listHeader{
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .listHeader .title{
      font-weight: 800;
      color: var(--c-gold);
    }
    .listHeader .count{
      color: var(--muted);
      font-size: 17px;
    }
    .list{
      max-height: 74vh;
      overflow:auto;
    }

    .row{
      display:flex;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      cursor:pointer;
    }
    .row:hover{ background: rgba(255,255,255,0.05); }
    .row.active{
      background: rgba(111,182,255,0.12);
      outline: 1px solid rgba(111,182,255,0.25);
    }

    .ico{
      width: 38px;
      height: 38px;
      border-radius: 8px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(202,161,74,0.20), rgba(0,0,0,0.25));
      border: 1px solid rgba(202,161,74,0.20);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.45);
      flex: 0 0 auto;
      display:grid;
      place-items:center;
      color: rgba(255,255,255,0.75);
      font-size: 17px;
      font-weight: 900;
    }

    .meta{ flex:1; min-width:0; }
    .meta .name{
      color: var(--c-white);
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta .sub{
      color: var(--muted);
      font-size: 17px;
      margin-top: 2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta .tiny{
      color: rgba(255,255,255,0.55);
      font-size: 17px;
      margin-top: 2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tooltipShell{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .tooltip{
      width: min(520px, 100%);
      padding: 14px 14px 12px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.78), rgba(0,0,0,0.55)),
        radial-gradient(900px 500px at 60% 10%, rgba(202,161,74,0.07), rgba(0,0,0,0) 55%);
      border: 2px solid var(--gold2);
      border-radius: 14px;
      box-shadow:
        0 0 0 2px rgba(202,161,74,0.18) inset,
        0 18px 50px rgba(0,0,0,0.60);
      position: sticky;
      top: 18px;
    }
    .tipTitle{
      text-align:center;
      font-weight: 900;
      font-size: 26px;
      letter-spacing: 0.6px;
      margin-top: 4px;
      margin-bottom: 8px;
      color: var(--c-blue);
      text-shadow: 0 2px 0 rgba(0,0,0,0.7);
    }
    .tipSubtitle{
      text-align:center;
      color: var(--c-gray);
      font-size: 17px;
      margin-top: -4px;
      margin-bottom: 10px;
      opacity: 0.95;
    }
    .hr{
      height:1px;
      background: linear-gradient(90deg, rgba(0,0,0,0), rgba(202,161,74,0.45), rgba(0,0,0,0));
      margin: 10px 0;
    }
    .line{
      font-size: 17px;
      line-height: 1.35;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.7);
      margin: 2px 0;
    }
    .line.dim{ color: rgba(217,211,199,0.78); }
    .line.req{ color: rgba(255,255,255,0.90); }

    .kv{
      display:flex;
      justify-content:space-between;
      gap:16px;
    }
    .kv span:first-child{
      min-width: 220px;
    }
    .kv span:last-child{
      text-align: right;
      white-space: nowrap;
    }
    .kv span:first-child{ color: rgba(255,255,255,0.82); }
    .kv span:last-child{ color: rgba(255,255,255,0.92); }

    .emptyState{
      color: rgba(255,255,255,0.75);
      text-align:center;
      padding: 28px 14px;
    }

    .list::-webkit-scrollbar{ width: 10px; }
    .list::-webkit-scrollbar-thumb{
      background: rgba(202,161,74,0.22);
      border: 2px solid rgba(0,0,0,0.55);
      border-radius: 10px;
    }
    .list::-webkit-scrollbar-track{ background: rgba(0,0,0,0.25); }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .tooltip{ position: relative; top:auto; }
      .list{ max-height: 46vh; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="controls">
      <div class="tabs">
        <div class="tab active" id="tabWeapons">Weapon</div>
        <div class="tab" id="tabArmors">Armor</div>
      </div>

      <input id="fileAny" class="fileHidden" type="file" accept=".json,application/json" />

      <div class="btn dev-only" id="loadWeaponsBtn">Load Weapons.json</div>
      <div class="btn dev-only" id="loadArmorsBtn">Load Armors.json</div>

      
      

      <input id="search" type="text" placeholder="Search item name…" />
      <select id="typeFilter" style="max-width:240px;">
        <option value="">All types</option>
      </select>
      <select id="tierFilter" style="max-width:180px;">
        <option value="">All tiers</option>
      </select>
      <div class="btn" id="reset">Reset</div>

      <div class="hint" id="hint">
        Load JSON via buttons (file picker = CORS-safe). Auto-load works only when served from the same origin.
      </div>
    </div>

    <div class="listPanel">
      <div class="listHeader">
        <div class="title" id="listTitle">Weapons</div>
        <div class="count" id="count">0 items</div>
      </div>
      <div class="list" id="list"></div>
    </div>

    <div class="tooltipShell">
      <div class="tooltip" id="tooltip">
        <div class="emptyState">Load a JSON file to begin.</div>
      </div>
    </div>
  </div>

  <script>
    const devEnv = false; // set true for dev mode
    const WEAPONS_PATH = "Weapons.json";
    const ARMORS_PATH  = "Armors.json";

    // ---- Helpers ----
    const n = (v) => (v === null || v === undefined) ? "" : String(v).trim();
    const has = (v) => n(v) !== "";
    const nz = (v) => has(v) && n(v) !== "0";
    const fmtSigned = (v) => {
      if(!has(v)) return "";
      const x = Number(v);
      if (Number.isNaN(x)) return String(v);
      return (x > 0 ? "+" : "") + x;
    };
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // dontDisplay: true => hide entirely
    function isDontDisplay(it){
      const v = it ? it.dontDisplay : false;
      return v === true || v === 1 || v === "1" || (typeof v === "string" && v.toLowerCase() === "true");
    }
    function filterVisible(arr){
      if (!Array.isArray(arr)) return [];
      return arr.filter(it => !isDontDisplay(it));
    }

    // ---- Type label logic ----
    function weaponTypeLabel(w){
      // Display: use displayName
      const primary =
        n(w.itemType?.displayName) ||
        n(w.displayType) ||
        n(w.type);

      const secondary =
        n(w.secondItemType?.displayName) ||
        n(w.secondDisplayType) ||
        n(w.secondType);

      if (has(secondary)) return `${primary} / ${secondary}`;
      return primary || "weapon";
    }

    function weaponTypeForFilter(w){
      return (
        n(w.itemType?.itemType) ||
        n(w.type)
      );
    }

    const ARMOR_TYPE_MAP = {
      helm: "Helm",
      tors: "Armor",
      shie: "Shield",
      glov: "Gloves",
      boot: "Boots",
      belt: "Belt",
      bels: "Belt",
      pelt: "Druid Pelt",
      phlm: "Barbarian Helm",
      ashd: "Paladin Shield",
      head: "Necromancer Head",
      circ: "Circlet"
    };

    function armorTypeLabel(a){
      const dt  = n(a.displayType);
      const sdt = n(a.secondDisplayType);

      const base = dt || (ARMOR_TYPE_MAP[n(a.type)] || n(a.type) || "armor");
      const sec  = has(sdt) ? sdt : "";

      if (has(sec)) return `${base} / ${sec}`;
      return base;
    }
    function armorTypeForFilter(a){
      return n(a.displayType) || (ARMOR_TYPE_MAP[n(a.type)] || n(a.type));
    }

    // ---- Visual tiny icon text ----
    function iconText(it){
      const c = n(it.code).toUpperCase();
      return c ? c.slice(0,3) : "ITM";
    }

    // ---- Weapon lines ----
    function weaponDmgLines(w){
      const out = [];
      const min = n(w.minDamage), max = n(w.maxDamage);
      const tmin = n(w.twoHandedMinDamage), tmax = n(w.twoHandedMaxDamage);
      const mmin = n(w.minMissileDamage), mmax = n(w.maxMissileDamage);

      if (has(min) && has(max)) out.push({k:"One-Hand Damage", v:`${min} to ${max}`});
      if (has(tmin) && has(tmax)) out.push({k:"Two-Hand Damage", v:`${tmin} to ${tmax}`});
      if (has(mmin) && has(mmax)) out.push({k:"Throw Damage", v:`${mmin} to ${mmax}`});
      return out;
    }

    // ---- Armor lines ----
    function armorDefenseLine(a){
      const minD = n(a.minDefense), maxD = n(a.maxDefense);
      if (has(minD) && has(maxD)) return `${minD} to ${maxD}`;
      if (has(minD)) return `${minD}`;
      return "";
    }

    function lineKV(k, v, extraClass=""){
      const cls = ("line kv " + (extraClass || "")).trim();
      return `
        <div class="${cls}">
          <span>${escapeHtml(k)}</span>
          <span>${escapeHtml(String(v))}</span>
        </div>
      `;
    }

    // ---- State ----
    let weapons = null;
    let armors  = null;

    let currentTab = "weapons"; // "weapons" | "armors"
    let items = [];
    let filtered = [];
    let activeIndex = -1;

    function setTab(tab){
      currentTab = tab;

      $("#tabWeapons").toggleClass("active", tab === "weapons");
      $("#tabArmors").toggleClass("active", tab === "armors");

      $("#listTitle").text(tab === "weapons" ? "Weapons" : "Armors");

      items = (tab === "weapons")
        ? (Array.isArray(weapons) ? weapons : [])
        : (Array.isArray(armors)  ? armors  : []);

      initFilters();
      applyFilters();

      if (!items.length){
        $("#list").html(`<div class="emptyState">${tab === "weapons" ? "Weapons" : "Armors"} not loaded.</div>`);
        $("#tooltip").html(`<div class="emptyState">Load a JSON file to begin.</div>`);
      }
    }

    function initFilters(){
      const $type = $("#typeFilter").empty();
      $type.append(`<option value="">All types</option>`);

      const $tier = $("#tierFilter").empty();
      $tier.append(`<option value="">All tiers</option>`);

      if (!items.length) return;

      const typeFn = (currentTab === "weapons") ? weaponTypeForFilter : armorTypeForFilter;

      const types = Array.from(new Set(items.map(typeFn).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      types.forEach(t => $type.append(`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`));

      const tiers = Array.from(new Set(items.map(it => n(it.itemTier)).filter(Boolean))).sort((a,b)=>{
        // numeric-aware sort if possible
        const an = Number(a), bn = Number(b);
        if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
        return a.localeCompare(b);
      });
      tiers.forEach(t => $tier.append(`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`));
    }

    function applyFilters(){
      const q = $("#search").val().trim().toLowerCase();
      const type = $("#typeFilter").val();
      const tier = $("#tierFilter").val();

      if (!items.length){
        $("#count").text("0 items");
        return;
      }

      const typeFn = (currentTab === "weapons") ? weaponTypeForFilter : armorTypeForFilter;

      filtered = items.filter(it => {
        // items already filtered by dontDisplay on load, but keep it safe:
        if (isDontDisplay(it)) return false;

        const name = (n(it.displayName) || n(it.name)).toLowerCase();
        const okName = !q || name.includes(q);
        const itType = typeFn(it);
        const okType = !type || itType === type;
        const itTier = n(it.itemTier);
        const okTier = !tier || itTier === tier;
        return okName && okType && okTier;
      });

      $("#count").text(`${filtered.length} items`);
      renderList();

      if (filtered.length){
        setActive(0);
      } else {
        activeIndex = -1;
        $("#tooltip").html(`<div class="emptyState">No items match your filters.</div>`);
      }
    }

    function renderList(){
      const $list = $("#list").empty();

      filtered.forEach((it, i) => {
        const title = n(it.displayName) || n(it.name) || "Unknown";
        const sub = (currentTab === "weapons") ? weaponTypeLabel(it) : armorTypeLabel(it);

        const tinyParts = [];
        if (currentTab === "weapons"){
          const dmg = weaponDmgLines(it);
          if (dmg.length) tinyParts.push(`${dmg[0].k.replace(" Damage","")}: ${dmg[0].v}`);
          if (nz(it.requiredLevel)) tinyParts.push(`Req Lvl ${n(it.requiredLevel)}`);
          if (nz(it.requiredStrength)) tinyParts.push(`Str ${n(it.requiredStrength)}`);
          if (has(it.itemTier)) tinyParts.push(`Tier ${n(it.itemTier)}`);
          if (nz(it.requiredDexterity)) tinyParts.push(`Dex ${n(it.requiredDexterity)}`);
          if (has(it.itemTier)) tinyParts.push(`Tier ${n(it.itemTier)}`);
        } else {
          const def = armorDefenseLine(it);
          if (has(def)) tinyParts.push(`Defense: ${def}`);
          if (nz(it.block)) tinyParts.push(`Block ${n(it.block)}%`);
          if (nz(it.maxSockets)) tinyParts.push(`Sockets ${n(it.maxSockets)}`);
          if (nz(it.requiredLevel)) tinyParts.push(`Req Lvl ${n(it.requiredLevel)}`);
          if (nz(it.requiredStrength)) tinyParts.push(`Str ${n(it.requiredStrength)}`);
          if (has(it.itemTier)) tinyParts.push(`Tier ${n(it.itemTier)}`);
        }

        const $row = $(`
          <div class="row" data-i="${i}">
            <div class="ico">${escapeHtml(iconText(it))}</div>
            <div class="meta">
              <div class="name">${escapeHtml(title)}</div>
              <div class="sub">${escapeHtml(sub)}</div>
              <div class="tiny">${escapeHtml(tinyParts.join(" • "))}</div>
            </div>
          </div>
        `);

        $row.on("click", () => setActive(i));
        $list.append($row);
      });

      if (activeIndex >= 0){
        $list.find(`.row[data-i="${activeIndex}"]`).addClass("active");
      }
    }

    function setActive(i){
      activeIndex = i;
      $("#list .row").removeClass("active");
      $(`#list .row[data-i="${i}"]`).addClass("active");

      const it = filtered[i];
      if (!it) return;

      if (currentTab === "weapons") renderWeaponTooltip(it);
      else renderArmorTooltip(it);
    }

    function renderWeaponTooltip(w){
      const $t = $("#tooltip").empty();
      const title = n(w.displayName) || n(w.name) || "Unknown Item";

      $t.append(`<div class="tipTitle">${escapeHtml(title)}</div>`);
      $t.append(`<div class="tipSubtitle">${escapeHtml(weaponTypeLabel(w))}</div>`);
      $t.append(`<div class="hr"></div>`);

      if (has(w.itemTier)) $t.append(lineKV("Item Tier:", n(w.itemTier), "dim"));

      const dmg = weaponDmgLines(w);
      dmg.forEach(d => $t.append(lineKV(d.k + ":", d.v)));

      if (has(w.speed)) $t.append(lineKV("Weapon Speed Modifier:", fmtSigned(w.speed) || n(w.speed)));

      if (has(w.noDurability) && n(w.noDurability) === "1") {
        $t.append(`<div class="line dim">Indestructible</div>`);
      } else if (has(w.durability)) {
        $t.append(lineKV("Durability:", n(w.durability)));
      }

      if (has(w.level)) $t.append(lineKV("Item Level:", n(w.level)));

      if (nz(w.requiredLevel)) {
        $t.append(lineKV("Required Level:", n(w.requiredLevel), "req"));
        }

      const reqs = [];
      if (nz(w.requiredStrength)) reqs.push({k:"Required Strength", v:n(w.requiredStrength)});
      if (nz(w.requiredDexterity)) reqs.push({k:"Required Dexterity", v:n(w.requiredDexterity)});

      if (reqs.length){
        $t.append(`<div class="hr"></div>`);
        reqs.forEach(r => $t.append(`<div class="line kv req"><span>${escapeHtml(r.k)}:</span><span>${escapeHtml(r.v)}</span></div>`));
      }

      const hints = [];
      if (n(w.oneOrTwoHanded) === "1") hints.push("One-Handed or Two-Handed");
      if (hints.length){
        $t.append(`<div class="hr"></div>`);
        hints.forEach(h => $t.append(`<div class="line dim">${escapeHtml(h)}</div>`));
      }

      $t.append(`<div class="hr"></div>`);
      $t.append(lineKV("Code:", n(w.code), "dim"));
    }

    function renderArmorTooltip(a){
      const $t = $("#tooltip").empty();
      const title = n(a.displayName) || n(a.name) || "Unknown Item";

      $t.append(`<div class="tipTitle">${escapeHtml(title)}</div>`);
      $t.append(`<div class="tipSubtitle">${escapeHtml(armorTypeLabel(a))}</div>`);
      $t.append(`<div class="hr"></div>`);

      if (has(a.itemTier)) $t.append(lineKV("Item Tier:", n(a.itemTier), "dim"));

      const def = armorDefenseLine(a);
      if (has(def)) $t.append(lineKV("Defense:", def));

      if (nz(a.block)) {
        $t.append(lineKV("Chance to Block:", `${n(a.block)}%`));
      }

      if (nz(a.maxSockets)) {
        $t.append(lineKV("Maximum Sockets:", n(a.maxSockets)));
      }

      if (has(a.durability)) {
        $t.append(lineKV("Durability:", n(a.durability)));
      }

      if (has(a.level)) {
        $t.append(lineKV("Item Level:", n(a.level)));
      }

      if (nz(a.requiredLevel)) {
        $t.append(lineKV("Required Level:", n(a.requiredLevel), "req"));
        }

      if (nz(a.requiredStrength)) {
        $t.append(lineKV("Required Strength:", n(a.requiredStrength), "req"));
      }

      $t.append(`<div class="hr"></div>`);
      $t.append(lineKV("Code:", n(a.code), "dim"));
    }

    // ---- Loading ----
    function showError(msg){
      $("#hint").html(`<span style="color: rgba(255,107,107,0.95)">${escapeHtml(msg)}</span>`);
    }
    function showHint(msg){
      $("#hint").html(msg);
    }

    function loadDataset(kind, arr, sourceLabel){
      if (!Array.isArray(arr)) throw new Error("Loaded JSON is not an array.");

      const visible = filterVisible(arr);
      if (kind === "weapons") weapons = visible;
      else armors = visible;

      const hiddenCount = arr.length - visible.length;
      const hiddenNote = hiddenCount > 0 ? ` (hidden: <b>${hiddenCount}</b>)` : "";

      showHint(`Loaded <b>${visible.length}</b> ${kind} from <b>${escapeHtml(sourceLabel)}</b>${hiddenNote}.`);
      setTab(currentTab);
    }

    function parseJsonText(text){
      const data = JSON.parse(text);
      if (typeof data === "string") return JSON.parse(data);
      return data;
    }

    function autoLoad(kind, path){
      $.getJSON(path)
        .done((data) => {
          try{
            if (typeof data === "string") data = JSON.parse(data);
            loadDataset(kind, data, path);
          } catch (e){
            console.error(e);
            showError(`Auto-load succeeded but parsing failed for ${path}.`);
          }
        })
        .fail((xhr) => {
          console.warn("Auto-load failed:", xhr);
          showError(`Auto-load failed for ${path} (CORS/file://). Use the file picker.`);
        });
    }

    function openFilePicker(expectedKind){
      const input = $("#fileAny");
      input.val("");
      input.data("expectedKind", expectedKind);

      // Temporarily allow interaction, then revert.
      input.css("pointer-events","auto");
      input.trigger("click");
      setTimeout(() => input.css("pointer-events","none"), 0);
    }

    function firstVisibleItem(arr){
      if (!Array.isArray(arr)) return null;
      for (const it of arr){
        if (!isDontDisplay(it)) return it;
      }
      return null;
    }

    // ---- Boot ----
    $(function(){
      if (devEnv) {
        $(".dev-only").show();
      } else {
        autoLoad("weapons", WEAPONS_PATH);
        autoLoad("armors", ARMORS_PATH);
      }

      $("#tabWeapons").on("click", () => setTab("weapons"));
      $("#tabArmors").on("click", () => setTab("armors"));

      $("#loadWeaponsBtn").on("click", () => openFilePicker("weapons"));
      $("#loadArmorsBtn").on("click", () => openFilePicker("armors"));

      $("#autoloadWeapons").on("click", () => autoLoad("weapons", WEAPONS_PATH));
      $("#autoloadArmors").on("click", () => autoLoad("armors", ARMORS_PATH));

      $("#search").on("input", applyFilters);
      $("#typeFilter").on("change", applyFilters);
      $("#tierFilter").on("change", applyFilters);
      $("#reset").on("click", () => {
        $("#search").val("");
        $("#typeFilter").val("");
        $("#tierFilter").val("");
        applyFilters();
      });

      $("#fileAny").on("change", async function(){
        try{
          const f = this.files?.[0];
          if (!f) return;

          const expectedKind = $(this).data("expectedKind") || "";
          const text = await f.text();
          const data = parseJsonText(text);

          let kind = expectedKind;
          if (!kind){
            const first = firstVisibleItem(data);
            kind = (first && Object.prototype.hasOwnProperty.call(first, "minDefense")) ? "armors" : "weapons";
          }

          loadDataset(kind, data, f.name);
        } catch (e){
          console.error(e);
          showError("Failed to parse JSON from selected file. Ensure it is valid JSON array.");
        }
      });

      // initial UI
      $("#count").text("0 items");
      $("#listTitle").text("Weapons");
      $("#list").html(`<div class="emptyState">Load Weapons.json or Armors.json to begin.</div>`);
      $("#tooltip").html(`<div class="emptyState">Load a JSON file to begin.</div>`);
    });
  </script>
</body>
</html>
